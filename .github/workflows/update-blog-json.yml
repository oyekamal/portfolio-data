name: Update Blog JSON Daily

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write # Required to commit and push changes

jobs:
  update-blog-json:
    name: Update blogs.json with latest blog posts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Create temporary README for blog posts
        run: |
          cat > /tmp/temp_readme.md << 'EOF'
          # Blog Posts
          <!-- BLOG-POST-LIST:START -->
          <!-- BLOG-POST-LIST:END -->
          EOF
      
      - name: Fetch latest blog posts from RSS feed
        uses: gautamkrishnar/blog-post-workflow@v1
        with:
          # Replace with your actual RSS feed URL(s)
          # Example: "https://dev.to/feed/yourusername" or "https://medium.com/feed/@yourusername"
          feed_list: "https://dev.to/feed/gautamkrishnar"
          readme_path: /tmp/temp_readme.md
          max_post_count: 10
          output_only: true
          disable_sort: false
          sort_order: desc
          template: '{"title": "$title", "url": "$url", "description": "$description", "date": "$date"},'
          date_format: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
          commit_message: "Updated blog posts"
          committer_username: "blog-update-bot"
          committer_email: "blog-update-bot@users.noreply.github.com"
      
      - name: Process blog posts and update JSON
        run: |
          # Read the output file generated by blog-post-workflow
          if [ -f /tmp/blog_post_workflow_output.json ]; then
            echo "Found blog post workflow output"
            cat /tmp/blog_post_workflow_output.json
            
            # Install jq for JSON processing
            sudo apt-get update && sudo apt-get install -y jq
            
            # Create a Node.js script to update blogs.json
            cat > /tmp/update_blogs.js << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          // Read the blog post workflow output
          let newPosts = [];
          try {
            const workflowOutput = fs.readFileSync('/tmp/blog_post_workflow_output.json', 'utf8');
            const parsed = JSON.parse(workflowOutput);
            
            // Extract posts from the workflow output
            if (Array.isArray(parsed)) {
              newPosts = parsed;
            }
          } catch (error) {
            console.error('Error reading workflow output:', error.message);
            process.exit(0); // Exit gracefully if no new posts
          }
          
          // Read existing blogs.json
          const blogsPath = path.join(process.cwd(), 'blogs.json');
          let blogsData;
          try {
            const blogsContent = fs.readFileSync(blogsPath, 'utf8');
            blogsData = JSON.parse(blogsContent);
          } catch (error) {
            console.error('Error reading blogs.json:', error.message);
            process.exit(1);
          }
          
          // Extract existing blog titles to avoid duplicates
          const existingTitles = new Set(blogsData.blogs.map(b => b.title));
          
          // Process new posts and add them if they don't exist
          let postsAdded = 0;
          newPosts.forEach((post, index) => {
            if (post.title && post.url && !existingTitles.has(post.title)) {
              // Create new blog entry matching existing structure
              const newBlog = {
                id: blogsData.blogs.length + postsAdded + 1,
                slug: post.title.toLowerCase()
                  .replace(/[^a-z0-9]+/g, '-')
                  .replace(/^-|-$/g, ''),
                title: post.title,
                description: post.description || post.title,
                content: {
                  introduction: post.description || '',
                  sections: []
                },
                author: {
                  name: "Portfolio Author",
                  avatar: "/images/avatar.jpg",
                  bio: "Software Developer"
                },
                publishedAt: post.pubDate || new Date().toISOString(),
                updatedAt: post.pubDate || new Date().toISOString(),
                featured: false,
                tags: post.categories || [],
                readTime: 5,
                views: 0,
                likes: 0,
                category: "Technology",
                coverImage: "/images/blog/default.jpg",
                externalUrl: post.url
              };
              
              blogsData.blogs.unshift(newBlog); // Add to beginning
              postsAdded++;
            }
          });
          
          if (postsAdded > 0) {
            // Write updated blogs.json
            fs.writeFileSync(blogsPath, JSON.stringify(blogsData, null, 2) + '\n');
            console.log(`Added ${postsAdded} new blog post(s) to blogs.json`);
          } else {
            console.log('No new blog posts to add');
          }
          SCRIPT
            
            # Run the update script
            node /tmp/update_blogs.js
          else
            echo "No blog post workflow output found, skipping update"
          fi
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet blogs.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to blogs.json"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in blogs.json"
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "blog-update-bot"
          git config user.email "blog-update-bot@users.noreply.github.com"
          git add blogs.json
          git commit -m "chore: update blogs.json with latest blog posts"
          git push
      
      - name: Summary
        run: |
          echo "Blog JSON update workflow completed successfully"
          if [ -f blogs.json ]; then
            echo "Current number of blogs: $(jq '.blogs | length' blogs.json)"
          fi
